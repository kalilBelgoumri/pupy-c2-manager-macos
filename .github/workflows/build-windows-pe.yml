name: Build Windows PE Binary

on:
  push:
    paths:
      - 'payload.py'
    branches: [ main, master ]
  workflow_dispatch:  # Manual trigger

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller pycryptodome
    
    - name: Build Windows PE executable
      run: |
        pyinstaller --onefile --console --distpath ./dist payload.py
    
    - name: Verify PE binary format
      run: |
        $bytes = [System.IO.File]::ReadAllBytes("dist/payload.exe")
        $magic = "{0:X2}{1:X2}" -f $bytes[0], $bytes[1]
        Write-Host "üìä Magic bytes: $magic"
        if ($magic -eq "4D5A") {
          Write-Host "‚úÖ Valid PE x64 binary!"
          Write-Host "üéâ Windows compilation successful!"
        } else {
          Write-Host "‚ùå Invalid PE format!"
          Write-Host "Expected: 4D5A (MZ)"
          Write-Host "Got: $magic"
          exit 1
        }
    
    - name: Display binary info
      run: |
        $file = "dist/payload.exe"
        $size = (Get-Item $file).Length / 1MB
        Write-Host "üì¶ Binary information:"
        Write-Host "  ‚îú‚îÄ Name: payload.exe"
        Write-Host "  ‚îú‚îÄ Size: $([Math]::Round($size, 2)) MB"
        Write-Host "  ‚îú‚îÄ Format: PE x64 (Windows)"
        Write-Host "  ‚îî‚îÄ Status: ‚úÖ Ready for deployment"
    
    - name: Upload Windows binary
      uses: actions/upload-artifact@v3
      with:
        name: payload-windows-pe
        path: dist/payload.exe
        retention-days: 30
    
    - name: Create Release (on tag)
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        files: dist/payload.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
